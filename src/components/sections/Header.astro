---
import { SITE_TITLE } from '../../consts';
import HeaderLink from './HeaderLink.astro';
import ThemeToggle from '../ui/button/ThemeToggle.astro';
---

<header class="bg-background text-foreground border-b sw-header">
    <nav class="mx-auto max-w-6xl px-4 py-2 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a class="no-underline hover:opacity-90 flex items-center gap-4" href="/" aria-label="Home" style="align-items: flex-end;">
                <img src="/cuny-seeklogo.png" alt="CUNY logo" aria-hidden="true" width="44" height="44" style="z-index:2; position:relative; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-left:-12px;" />
                <img src="/assets/logos/cuny_med.png" alt="CUNY Med logo" aria-hidden="true" width="110" height="110" style="margin-left:0; border-radius: 12px; background: white; box-shadow:0 2px 8px rgba(0,0,0,0.04); z-index:1; position:relative;" />
            </a>
            <div class="internal-links hidden md:flex items-center gap-2 ml-1">
                <HeaderLink href="/" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">Home</HeaderLink>
                <HeaderLink href="/about" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">About Us</HeaderLink>
                <HeaderLink href="/team" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">Team</HeaderLink>

                <!-- Research Dropdown -->
                <div class="relative group">
                    <button class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline hover:text-[color:var(--accent)] flex items-center gap-1 transition-colors">
                        Research
                        <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="absolute left-0 mt-0 w-48 bg-[color:var(--color-bg-primary)] border border-[color:var(--color-border)] rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                        <a href="/portfolio" class="block px-4 py-3 text-[color:var(--color-text-secondary)] hover:bg-[color:var(--color-bg-secondary)] hover:text-[color:var(--accent)] transition-colors first:rounded-t-lg no-underline">Projects</a>
                        <a href="/publication" class="block px-4 py-3 text-[color:var(--color-text-secondary)] hover:bg-[color:var(--color-bg-secondary)] hover:text-[color:var(--accent)] transition-colors last:rounded-b-lg no-underline">Publication</a>
                    </div>
                </div>

                <HeaderLink href="/blog" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">Blog</HeaderLink>
                <HeaderLink href="/resources" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">Resources</HeaderLink>
                <HeaderLink href="/contact" class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline">Contact</HeaderLink>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <ThemeToggle />
            <button type="button" aria-label="Open menu" aria-controls="mobile-menu" aria-expanded="false" data-menu-btn class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg text-[color:var(--color-text-secondary)] hover:text-white">
                <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true"><path fill="currentColor" d="M3 6h18v2H3V6Zm0 5h18v2H3v-2Zm0 5h18v2H3v-2Z"/></svg>
            </button>
        </div>
    </nav>
    <div id="mobile-menu" class="md:hidden hidden border-t">
        <div class="mx-auto max-w-6xl px-4 py-3 flex flex-col gap-2">
            <div class="flex flex-col">
                <HeaderLink href="/" class="px-2 py-3">Home</HeaderLink>
                <HeaderLink href="/about" class="px-2 py-3">About Us</HeaderLink>
                <HeaderLink href="/team" class="px-2 py-3">Team</HeaderLink>

                <!-- Research Submenu (Mobile) -->
                <div>
                    <button type="button" data-mobile-research-toggle class="w-full text-left px-2 py-3 text-[color:var(--color-text-secondary)] hover:text-[color:var(--accent)] flex items-center justify-between transition-colors">
                        <span>Research</span>
                        <svg class="w-4 h-4 transition-transform" data-mobile-research-icon fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div data-mobile-research-menu class="hidden pl-4">
                        <HeaderLink href="/portfolio" class="px-2 py-2 text-sm">Projects</HeaderLink>
                        <HeaderLink href="/publication" class="px-2 py-2 text-sm">Publication</HeaderLink>
                    </div>
                </div>

                <HeaderLink href="/blog" class="px-2 py-3">Blog</HeaderLink>
                <HeaderLink href="/resources" class="px-2 py-3">Resources</HeaderLink>
                <HeaderLink href="/contact" class="px-2 py-3">Contact</HeaderLink>
            </div>
        </div>
    </div>
</header>

<script is:inline>
  const btn = document.querySelector('[data-menu-btn]');
  const panel = document.getElementById('mobile-menu');
  function toggleMenu() {
    if (!panel || !btn) return;
    const isOpen = !panel.classList.contains('hidden');
    if (isOpen) {
      panel.classList.add('hidden');
      btn.setAttribute('aria-expanded', 'false');
    } else {
      panel.classList.remove('hidden');
      btn.setAttribute('aria-expanded', 'true');
    }
  }
  btn?.addEventListener('click', toggleMenu);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') {
    if (!panel?.classList.contains('hidden')) toggleMenu();
  }});
  document.addEventListener('click', (e) => {
    if (!panel || !btn) return;
    const target = e.target;
    const clickedInside = panel.contains(target) || btn.contains(target);
    if (!clickedInside && !panel.classList.contains('hidden')) toggleMenu();
  });

  // Mobile Research submenu toggle
  const researchToggle = document.querySelector('[data-mobile-research-toggle]');
  const researchMenu = document.querySelector('[data-mobile-research-menu]');
  const researchIcon = document.querySelector('[data-mobile-research-icon]');

  researchToggle?.addEventListener('click', () => {
    if (researchMenu) {
      const isHidden = researchMenu.classList.contains('hidden');
      if (isHidden) {
        researchMenu.classList.remove('hidden');
        researchIcon?.classList.add('rotate-180');
      } else {
        researchMenu.classList.add('hidden');
        researchIcon?.classList.remove('rotate-180');
      }
    }
  });
</script>
